\hypertarget{grain_8c_source}{}\doxysubsection{grain.\+c}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001 }
\DoxyCodeLine{00016 \textcolor{preprocessor}{\#include "\mbox{\hyperlink{grain_8h}{grain.h}}"}}
\DoxyCodeLine{00017 \textcolor{preprocessor}{\#include "\mbox{\hyperlink{c__granular__synth_8h}{c\_granular\_synth.h}}"}}
\DoxyCodeLine{00018 \textcolor{preprocessor}{\#include "\mbox{\hyperlink{envelope_8h}{envelope.h}}"}}
\DoxyCodeLine{00019 \textcolor{preprocessor}{\#include "\mbox{\hyperlink{purple__utils_8h}{purple\_utils.h}}"}}
\DoxyCodeLine{00020 }
\DoxyCodeLine{\Hypertarget{grain_8c_source_l00031}\mbox{\hyperlink{grain_8h_add05c8e2a37126d9bd6f745368b130ed}{00031}} \mbox{\hyperlink{structgrain}{grain}} \mbox{\hyperlink{grain_8c_add05c8e2a37126d9bd6f745368b130ed}{grain\_new}}(\textcolor{keywordtype}{int} grain\_size\_samples, \textcolor{keywordtype}{int} soundfile\_size, \textcolor{keywordtype}{float} start\_pos, \textcolor{keywordtype}{int} grain\_index, \textcolor{keywordtype}{float} time\_stretch\_factor)}
\DoxyCodeLine{00032 \{}
\DoxyCodeLine{00033     \mbox{\hyperlink{structgrain}{grain}} x;}
\DoxyCodeLine{00034     x.\mbox{\hyperlink{structgrain_a55cdc993050e6e886756b0e338dfb85d}{grain\_active}} = \textcolor{keyword}{false};}
\DoxyCodeLine{00035     x.\mbox{\hyperlink{structgrain_ac3f579526e827c8e44bbe1e725ec9dc4}{grain\_size\_samples}} = grain\_size\_samples;}
\DoxyCodeLine{00036     x.\mbox{\hyperlink{structgrain_aa279b25631b91e8d1dee9edd79453ff4}{grain\_index}} = grain\_index;}
\DoxyCodeLine{00037     x.\mbox{\hyperlink{structgrain_a77f7d08ef6d5b0813156e9d47badc914}{internal\_step\_count}} = 0;}
\DoxyCodeLine{00038     x.\mbox{\hyperlink{structgrain_a6909b3ca1a15b560f9af844e8e965ead}{time\_stretch\_factor}} = time\_stretch\_factor;}
\DoxyCodeLine{00039     \textcolor{keywordtype}{bool} reverse\_playback = x.\mbox{\hyperlink{structgrain_a6909b3ca1a15b560f9af844e8e965ead}{time\_stretch\_factor}} < 0.0;}
\DoxyCodeLine{00040     }
\DoxyCodeLine{00041     x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} = start\_pos;}
\DoxyCodeLine{00042     \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} < 0) x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} += (soundfile\_size -\/ 1);}
\DoxyCodeLine{00043     x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} = x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} + ((x.\mbox{\hyperlink{structgrain_ac3f579526e827c8e44bbe1e725ec9dc4}{grain\_size\_samples}} -\/ 1) * x.\mbox{\hyperlink{structgrain_a6909b3ca1a15b560f9af844e8e965ead}{time\_stretch\_factor}});}
\DoxyCodeLine{00044     }
\DoxyCodeLine{00045     \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} < 0) x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} += soundfile\_size -\/ 1;}
\DoxyCodeLine{00046     \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} > soundfile\_size -\/ 1) x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} -\/= (soundfile\_size -\/ 1);}
\DoxyCodeLine{00047 }
\DoxyCodeLine{00048     x.\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} = x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}};}
\DoxyCodeLine{00049     x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} = x.\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} + x.\mbox{\hyperlink{structgrain_a6909b3ca1a15b560f9af844e8e965ead}{time\_stretch\_factor}};}
\DoxyCodeLine{00050     }
\DoxyCodeLine{00051     \textcolor{keywordflow}{if}(reverse\_playback)}
\DoxyCodeLine{00052     \{}
\DoxyCodeLine{00053         \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} < 0) x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} += (soundfile\_size -\/ 1);}
\DoxyCodeLine{00054         \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} < x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} \&\& x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} > x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}}) x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} = x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}};}
\DoxyCodeLine{00055  }
\DoxyCodeLine{00056     \}}
\DoxyCodeLine{00057     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00058     \{}
\DoxyCodeLine{00059         \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} > (soundfile\_size -\/ 1)) x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} -\/= (soundfile\_size -\/ 1);}
\DoxyCodeLine{00060         \textcolor{keywordflow}{if}(x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} >= x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} \&\& x.\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} < x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}}) x.\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} = x.\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}};}
\DoxyCodeLine{00061     \}}
\DoxyCodeLine{00062 }
\DoxyCodeLine{00063     \textcolor{keywordflow}{return} x;}
\DoxyCodeLine{00064 \}}
\DoxyCodeLine{\Hypertarget{grain_8c_source_l00072}\mbox{\hyperlink{grain_8c_a25635e32880f4c39cdf848a5820aa9d9}{00072}} \textcolor{keywordtype}{void} \mbox{\hyperlink{grain_8c_a25635e32880f4c39cdf848a5820aa9d9}{grain\_internal\_scheduling}}(\mbox{\hyperlink{structgrain}{grain}}* g, \mbox{\hyperlink{structc__granular__synth}{c\_granular\_synth}}* synth)}
\DoxyCodeLine{00073 \{}
\DoxyCodeLine{00074     \textcolor{keywordflow}{if}(synth-\/>\mbox{\hyperlink{structc__granular__synth_a11189b409749c9930f477892a71de86d}{reverse\_playback}})}
\DoxyCodeLine{00075     \{}
\DoxyCodeLine{00076         g-\/>\mbox{\hyperlink{structgrain_a55cdc993050e6e886756b0e338dfb85d}{grain\_active}} = g-\/>\mbox{\hyperlink{structgrain_aa279b25631b91e8d1dee9edd79453ff4}{grain\_index}} == synth-\/>\mbox{\hyperlink{structc__granular__synth_a6a4bd1fc4f1624d14cc9bf9e11e1f661}{current\_grain\_index}} ||}
\DoxyCodeLine{00077         ((((synth-\/>\mbox{\hyperlink{structc__granular__synth_aa2f524c1b162d569fdafccecbe8199f3}{soundfile\_length}} -\/ 1 -\/ synth-\/>\mbox{\hyperlink{structc__granular__synth_a9f10a2ae717bf695c448157ddab09c85}{playback\_position}}) <= g-\/>\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}}) \&\&}
\DoxyCodeLine{00078           ((synth-\/>\mbox{\hyperlink{structc__granular__synth_aa2f524c1b162d569fdafccecbe8199f3}{soundfile\_length}} -\/ 1 -\/ synth-\/>\mbox{\hyperlink{structc__granular__synth_a9f10a2ae717bf695c448157ddab09c85}{playback\_position}}) >= g-\/>\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}})));}
\DoxyCodeLine{00079     \}}
\DoxyCodeLine{00080     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00081     \{}
\DoxyCodeLine{00082         g-\/>\mbox{\hyperlink{structgrain_a55cdc993050e6e886756b0e338dfb85d}{grain\_active}} = g-\/>\mbox{\hyperlink{structgrain_aa279b25631b91e8d1dee9edd79453ff4}{grain\_index}} == synth-\/>\mbox{\hyperlink{structc__granular__synth_a6a4bd1fc4f1624d14cc9bf9e11e1f661}{current\_grain\_index}} ||}
\DoxyCodeLine{00083         ((g-\/>\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}} <= synth-\/>\mbox{\hyperlink{structc__granular__synth_a9f10a2ae717bf695c448157ddab09c85}{playback\_position}}) \&\&}
\DoxyCodeLine{00084          (g-\/>\mbox{\hyperlink{structgrain_a971aaec2d8e0b45df1e364c8e16dda57}{end}} >= synth-\/>\mbox{\hyperlink{structc__granular__synth_a9f10a2ae717bf695c448157ddab09c85}{playback\_position}}));}
\DoxyCodeLine{00085     \}}
\DoxyCodeLine{00086     }
\DoxyCodeLine{00087     \textcolor{keywordflow}{if}(g-\/>\mbox{\hyperlink{structgrain_a55cdc993050e6e886756b0e338dfb85d}{grain\_active}})}
\DoxyCodeLine{00088     \{}
\DoxyCodeLine{00089         \textcolor{keywordtype}{float}   left\_sample, }
\DoxyCodeLine{00090                 right\_sample, }
\DoxyCodeLine{00091                 frac, }
\DoxyCodeLine{00092                 integral, }
\DoxyCodeLine{00093                 weighted;}
\DoxyCodeLine{00094         }
\DoxyCodeLine{00095         left\_sample = synth-\/>\mbox{\hyperlink{structc__granular__synth_ad78acae3cc48dab4d1e4ab118872ec27}{soundfile\_table}}[(int)floorf(g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}})];}
\DoxyCodeLine{00096         right\_sample = synth-\/>\mbox{\hyperlink{structc__granular__synth_ad78acae3cc48dab4d1e4ab118872ec27}{soundfile\_table}}[(int)ceilf(g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}})];}
\DoxyCodeLine{00097         frac = modff(g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}}, \&integral);}
\DoxyCodeLine{00098         weighted = \mbox{\hyperlink{purple__utils_8c_a228b2ef6097d375daeea9358a534ce54}{get\_interpolated\_sample\_value}}(left\_sample, right\_sample,frac);}
\DoxyCodeLine{00099         synth-\/>\mbox{\hyperlink{structc__granular__synth_a3536cd671fe04bd9e84cbdb501ecbe00}{output\_buffer}} += weighted;}
\DoxyCodeLine{00100         g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} = g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}};}
\DoxyCodeLine{00101         g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} += synth-\/>\mbox{\hyperlink{structc__granular__synth_a5d91e370701d04209bc69e60a84ff402}{pitch\_factor}};}
\DoxyCodeLine{00102 }
\DoxyCodeLine{00103         \textcolor{keywordflow}{if}(g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} > (synth-\/>\mbox{\hyperlink{structc__granular__synth_aa2f524c1b162d569fdafccecbe8199f3}{soundfile\_length}} -\/ 1))}
\DoxyCodeLine{00104         \{}
\DoxyCodeLine{00105             g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} -\/= (synth-\/>\mbox{\hyperlink{structc__granular__synth_aa2f524c1b162d569fdafccecbe8199f3}{soundfile\_length}} -\/ 1);}
\DoxyCodeLine{00106         \}}
\DoxyCodeLine{00107         }
\DoxyCodeLine{00108         \textcolor{keywordflow}{if}(g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} < 0.0)}
\DoxyCodeLine{00109         \{}
\DoxyCodeLine{00110             g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} += (synth-\/>\mbox{\hyperlink{structc__granular__synth_aa2f524c1b162d569fdafccecbe8199f3}{soundfile\_length}} -\/ 1);}
\DoxyCodeLine{00111         \}}
\DoxyCodeLine{00112         g-\/>\mbox{\hyperlink{structgrain_a77f7d08ef6d5b0813156e9d47badc914}{internal\_step\_count}}++;}
\DoxyCodeLine{00113         }
\DoxyCodeLine{00114         \textcolor{keywordflow}{if}(g-\/>\mbox{\hyperlink{structgrain_a77f7d08ef6d5b0813156e9d47badc914}{internal\_step\_count}} >= g-\/>\mbox{\hyperlink{structgrain_ac3f579526e827c8e44bbe1e725ec9dc4}{grain\_size\_samples}})}
\DoxyCodeLine{00115         \{}
\DoxyCodeLine{00116             g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} = g-\/>\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}};}
\DoxyCodeLine{00117             g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} = g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} + synth-\/>\mbox{\hyperlink{structc__granular__synth_a5d91e370701d04209bc69e60a84ff402}{pitch\_factor}};}
\DoxyCodeLine{00118             g-\/>\mbox{\hyperlink{structgrain_a77f7d08ef6d5b0813156e9d47badc914}{internal\_step\_count}} = 0;}
\DoxyCodeLine{00119             synth-\/>\mbox{\hyperlink{structc__granular__synth_a08fe6ec8d8447dbab42226cde74bf814}{spray\_true\_offset}} = 0;}
\DoxyCodeLine{00120             \mbox{\hyperlink{structpd__granular__synth__tilde_aa4bc811658b8df54563de4af0ca045f1}{c\_granular\_synth\_reset\_playback\_position}}(synth);}
\DoxyCodeLine{00121         \}}
\DoxyCodeLine{00122         }
\DoxyCodeLine{00123         \textcolor{keywordflow}{if}(g-\/>\mbox{\hyperlink{structgrain_afbf47a53c6afd71b938b4bb2aa4a8143}{next\_grain}})}
\DoxyCodeLine{00124         \{}
\DoxyCodeLine{00125             \mbox{\hyperlink{grain_8c_a25635e32880f4c39cdf848a5820aa9d9}{grain\_internal\_scheduling}}(g-\/>\mbox{\hyperlink{structgrain_afbf47a53c6afd71b938b4bb2aa4a8143}{next\_grain}}, synth);}
\DoxyCodeLine{00126         \}}
\DoxyCodeLine{00127         }
\DoxyCodeLine{00128     \}}
\DoxyCodeLine{00129     \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00130         g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} = g-\/>\mbox{\hyperlink{structgrain_a1f3a346626963438c6b4f934cf2c9011}{start}};}
\DoxyCodeLine{00131         g-\/>\mbox{\hyperlink{structgrain_a915424dcb7cddd180aef2d61da20f693}{next\_sample\_pos}} = g-\/>\mbox{\hyperlink{structgrain_afe77b379af00742a9fb66495ab2accbe}{current\_sample\_pos}} + synth-\/>\mbox{\hyperlink{structc__granular__synth_a5d91e370701d04209bc69e60a84ff402}{pitch\_factor}};}
\DoxyCodeLine{00132         g-\/>\mbox{\hyperlink{structgrain_a77f7d08ef6d5b0813156e9d47badc914}{internal\_step\_count}} = 0;}
\DoxyCodeLine{00133         \textcolor{keywordflow}{return};}
\DoxyCodeLine{00134         }
\DoxyCodeLine{00135     \}}
\DoxyCodeLine{00136 \}}
\DoxyCodeLine{\Hypertarget{grain_8c_source_l00142}\mbox{\hyperlink{grain_8h_a95667aefa8dd361c1f8dfba4ecbbf670}{00142}} \textcolor{keywordtype}{void} \mbox{\hyperlink{grain_8c_a95667aefa8dd361c1f8dfba4ecbbf670}{grain\_free}}(\mbox{\hyperlink{structgrain}{grain}} *x)}
\DoxyCodeLine{00143 \{}
\DoxyCodeLine{00144     free(x);}
\DoxyCodeLine{00145 \}}

\end{DoxyCode}
